<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GÃ©nÃ©ration de document</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-start min-h-screen py-10">

  <form id="docForm" class="bg-white p-6 rounded-2xl shadow-md w-full max-w-md space-y-4">
    <h2 class="text-2xl font-bold text-center">GÃ©nÃ©ration de document</h2>
    
    <button type="button" id="fillTestData" class="w-full py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
      ðŸŽ² Remplir avec donnÃ©es de test
    </button>

    <!-- SÃ©lecteur de template (toujours visible) -->
    <select id="template" class="w-full p-2 border rounded-lg" required>
      <option value="">ðŸ“„ Choisir un type de document...</option>
    </select>

    <!-- Champs dynamiques gÃ©nÃ©rÃ©s depuis variables.json -->
    <div id="dynamicFields" class="space-y-4"></div>

    <!-- Destinataires (toujours visible) -->
    <div class="w-full">
      <label class="block text-sm font-medium text-gray-700 mb-1">Destinataires</label>
      <div id="emailContainer" class="w-full p-2 border rounded-lg bg-white flex flex-wrap gap-2 items-center min-h-[42px] cursor-text">
        <input id="emailInput" type="text" placeholder="Tapez une adresse email et appuyez sur virgule ou espace..." class="flex-1 outline-none min-w-[200px]">
      </div>
      <input id="destinataires" type="hidden" required>
    </div>

    <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
      GÃ©nÃ©rer le document
    </button>

    <p id="message" class="text-center text-gray-700"></p>
  </form>

  <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-auto p-6 relative">
      <button id="closeModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      <div id="previewContent"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById("docForm")
    const msg = document.getElementById("message")
    const previewModal = document.getElementById("previewModal")
    const previewContent = document.getElementById("previewContent")
    const closeModal = document.getElementById("closeModal")
    const templateSelect = document.getElementById("template")
    const dynamicFields = document.getElementById("dynamicFields")
    
    let variablesConfig = null
    let currentTemplate = null

    // Charger variables.json au dÃ©marrage
    async function loadVariablesConfig() {
      try {
        const response = await fetch('/config/variables.json')
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }
        
        const text = await response.text()
        if (!text || text.trim() === '') {
          throw new Error('Empty response from server')
        }
        
        variablesConfig = JSON.parse(text)
        
        // Remplir le sÃ©lecteur de templates
        templateSelect.innerHTML = '<option value="">ðŸ“„ Choisir un type de document...</option>'
        Object.keys(variablesConfig.templates).forEach(key => {
          const template = variablesConfig.templates[key]
          const option = document.createElement('option')
          option.value = key
          option.textContent = template.nom
          templateSelect.appendChild(option)
        })
        
        console.log('Variables config loaded:', variablesConfig)
      } catch (error) {
        console.error('Erreur chargement variables.json:', error)
        msg.textContent = `âŒ Impossible de charger la configuration: ${error.message}`
        msg.style.color = '#dc2626'
      }
    }

    // GÃ©nÃ©rer les champs dynamiquement
    function generateFields(templateKey) {
      if (!variablesConfig) return
      
      dynamicFields.innerHTML = ''
      currentTemplate = templateKey
      
      const template = variablesConfig.templates[templateKey]
      if (!template) return

      // === SECTION COORDONNÃ‰ES ===
      const coordSection = document.createElement('div')
      coordSection.className = 'space-y-3 p-4 border-2 border-blue-200 rounded-lg bg-blue-50'
      
      const coordLabel = document.createElement('h3')
      coordLabel.className = 'text-sm font-semibold text-blue-900 mb-3'
      coordLabel.textContent = 'ðŸ“‹ CoordonnÃ©es'
      coordSection.appendChild(coordLabel)

      // Ordre des champs pour la section CoordonnÃ©es
      const coordFields = ['entreprise', 'civilite', 'statut', 'batiment', 'adresse', 'cp']
      
      coordFields.forEach(key => {
        const variable = variablesConfig.variables_communes[key]
        if (variable && variable.type !== 'auto') {
          const field = createField(key, variable)
          if (field) coordSection.appendChild(field)
        }
      })
      
      dynamicFields.appendChild(coordSection)

      // === VARIABLES SPÃ‰CIFIQUES AU TEMPLATE ===
      if (template.variables_specifiques) {
        const templateSection = document.createElement('div')
        templateSection.className = 'space-y-3 p-4 border-2 border-green-200 rounded-lg bg-green-50 mt-4'
        
        const templateLabel = document.createElement('h3')
        templateLabel.className = 'text-sm font-semibold text-green-900 mb-3'
        templateLabel.textContent = 'ðŸ“ Contenu de la demande'
        templateSection.appendChild(templateLabel)
        
        Object.keys(template.variables_specifiques).forEach(key => {
          const variable = template.variables_specifiques[key]
          const field = createField(key, variable)
          if (field) templateSection.appendChild(field)
        })
        
        dynamicFields.appendChild(templateSection)
      }

      // === BLOC DONNÃ‰ES DE L'EXPÃ‰DITEUR ===
      const otherSection = document.createElement('div')
      otherSection.className = 'space-y-3 p-4 border-2 border-purple-200 rounded-lg bg-purple-50 mt-4'
      
      const otherLabel = document.createElement('h3')
      otherLabel.className = 'text-sm font-semibold text-purple-900 mb-3'
      otherLabel.textContent = 'ðŸ‘¤ DonnÃ©es de l\'expÃ©diteur'
      otherSection.appendChild(otherLabel)
      
      // Ajouter uniquement nom_exp
      const expediteurFields = ['nom_exp']
      
      expediteurFields.forEach(key => {
        const variable = variablesConfig.variables_communes[key]
        if (variable && variable.type !== 'auto') {
          const field = createField(key, variable)
          if (field) otherSection.appendChild(field)
        }
      })
      
      if (otherSection.children.length > 1) {
        dynamicFields.appendChild(otherSection)
      }
    }

    // CrÃ©er un champ HTML depuis la config
    function createField(key, config) {
      if (config.type === 'select') {
        const select = document.createElement('select')
        select.id = key
        select.className = 'w-full p-2 border rounded-lg'
        select.required = config.required || false
        
        const defaultOption = document.createElement('option')
        defaultOption.value = ''
        defaultOption.textContent = config.label
        select.appendChild(defaultOption)
        
        config.options.forEach(opt => {
          const option = document.createElement('option')
          option.value = opt
          option.textContent = opt
          select.appendChild(option)
        })
        
        return select
      } else if (config.type === 'textarea') {
        const textarea = document.createElement('textarea')
        textarea.id = key
        textarea.placeholder = config.placeholder || config.label
        textarea.rows = config.rows || 3
        textarea.className = 'w-full p-2 border rounded-lg'
        textarea.required = config.required || false
        return textarea
      } else {
        const input = document.createElement('input')
        input.id = key
        input.type = config.type === 'email' ? 'email' : 'text'
        input.placeholder = config.placeholder || config.label
        input.className = 'w-full p-2 border rounded-lg'
        input.required = config.required || false
        if (config.default) input.value = config.default
        return input
      }
    }

    // DÃ©tecter changement de template
    templateSelect.addEventListener('change', (e) => {
      if (e.target.value) {
        generateFields(e.target.value)
      } else {
        dynamicFields.innerHTML = ''
      }
    })

    // Charger la config au dÃ©marrage
    loadVariablesConfig()
    
    // Gestion des chips d'emails inline
    const emailInput = document.getElementById("emailInput")
    const emailContainer = document.getElementById("emailContainer")
    const destinatairesHidden = document.getElementById("destinataires")
    let emails = []
    
    function createChip(email) {
      const chip = document.createElement('div')
      chip.className = 'flex items-center gap-1 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm'
      chip.innerHTML = `
        <span>${email}</span>
        <button type="button" class="ml-1 text-blue-600 hover:text-blue-900 font-bold text-lg leading-none">&times;</button>
      `
      chip.querySelector('button').addEventListener('click', () => {
        const index = emails.indexOf(email)
        if (index > -1) {
          emails.splice(index, 1)
          chip.remove()
          updateHiddenField()
        }
      })
      return chip
    }
    
    function updateHiddenField() {
      destinatairesHidden.value = emails.join(', ')
    }
    
    function addEmail(email) {
      email = email.trim()
      if (email && email.includes('@') && !emails.includes(email)) {
        emails.push(email)
        const chip = createChip(email)
        emailContainer.insertBefore(chip, emailInput)
        updateHiddenField()
        return true
      }
      return false
    }
    
    emailInput.addEventListener('input', (e) => {
      const value = e.target.value
      if (value.includes(',') || value.includes(';') || value.includes(' ')) {
        const parts = value.split(/[,;\s]+/)
        parts.forEach(part => {
          if (part.trim()) {
            addEmail(part)
          }
        })
        emailInput.value = ''
      }
    })
    
    emailInput.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && emailInput.value === '' && emails.length > 0) {
        emails.pop()
        const chips = emailContainer.querySelectorAll('div')
        if (chips.length > 0) {
          chips[chips.length - 1].remove()
        }
        updateHiddenField()
      }
      if (e.key === 'Enter') {
        e.preventDefault()
        if (emailInput.value.trim()) {
          addEmail(emailInput.value)
          emailInput.value = ''
        }
      }
    })
    
    emailContainer.addEventListener('click', () => {
      emailInput.focus()
    })
    
    // Bouton pour remplir avec des donnÃ©es de test
    document.getElementById('fillTestData').addEventListener('click', () => {
      // SÃ©lectionner un template alÃ©atoire si pas dÃ©jÃ  sÃ©lectionnÃ©
      if (!templateSelect.value && variablesConfig) {
        const templates = Object.keys(variablesConfig.templates)
        const randomTemplate = templates[Math.floor(Math.random() * templates.length)]
        templateSelect.value = randomTemplate
        generateFields(randomTemplate)
      }

      const testData = {
        entreprise: ['ACME Corp', 'TechCo', 'Industries SA', 'Solutions SARL'][Math.floor(Math.random() * 4)],
        civilite: ['Monsieur', 'Madame'][Math.floor(Math.random() * 2)],
        statut: ['PrÃ©sident', 'Directeur', 'Responsable RH', 'Chef de service'][Math.floor(Math.random() * 4)],
        batiment: ['BÃ¢timent A', 'BÃ¢timent B', 'Tour Nord', 'Annexe'][Math.floor(Math.random() * 4)],
        adresse: ['123 Rue de la Paix', '45 Avenue des Champs', '78 Boulevard Saint-Michel', '12 Place de la RÃ©publique'][Math.floor(Math.random() * 4)],
        cp: ['75001 Paris', '69002 Lyon', '13001 Marseille', '44000 Nantes'][Math.floor(Math.random() * 4)],
        number: ['2025-' + String(Math.floor(Math.random() * 100) + 1).padStart(3, '0')],
        civilite_replace: ['Monsieur', 'Madame'][Math.floor(Math.random() * 2)],
        nom_replace: ['Durand', 'Petit', 'Robert', 'Moreau'][Math.floor(Math.random() * 4)],
        civilite_nomme: ['Monsieur', 'Madame'][Math.floor(Math.random() * 2)],
        nom_nomme: ['Lefebvre', 'Girard', 'Rousseau', 'Leroy'][Math.floor(Math.random() * 4)],
        email_nomme: ['lefebvre@example.com', 'girard@example.com', 'rousseau@example.com'][Math.floor(Math.random() * 3)],
        nom_exp: ['FO METAUX', 'Force OuvriÃ¨re', 'Syndicat FO'][Math.floor(Math.random() * 3)],
        texte_ia: 'Ceci est un texte de test gÃ©nÃ©rÃ© automatiquement pour la dÃ©monstration.',
        emails: ['epheandrill@gmail.com', 'bouvier.jul@gmail.com']
      }
      
      // Remplir tous les champs dynamiques
      Object.keys(testData).forEach(key => {
        if (key === 'emails') return // GÃ©rÃ© sÃ©parÃ©ment
        const field = document.getElementById(key)
        if (field) field.value = testData[key]
      })
      
      // Remplir les emails avec chips
      emails = []
      emailContainer.querySelectorAll('div').forEach(chip => chip.remove())
      testData.emails.forEach(email => addEmail(email))
    })

    form.addEventListener("submit", async (e) => {
      e.preventDefault()
      msg.textContent = "Envoi en cours..."

      // Collecter toutes les donnÃ©es des champs dynamiques
      const data = {
        template: templateSelect.value,
        destinataires: document.getElementById("destinataires").value
      }

      // Ajouter toutes les valeurs des champs gÃ©nÃ©rÃ©s dynamiquement
      const allInputs = dynamicFields.querySelectorAll('input, select, textarea')
      allInputs.forEach(input => {
        data[input.id] = input.value || ''
      })

      try {
        const res = await fetch("http://localhost:3000/webhook/formulaire-doc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })

        if (!res.ok) {
          const errorText = await res.text()
          console.error(`Erreur ${res.status}:`, errorText)
          
          let errorMessage = `Erreur ${res.status}: `
          if (res.status === 404) {
            errorMessage += "Le webhook n'existe pas dans n8n.\n\n"
            errorMessage += "VÃ©rifiez dans n8n (http://localhost:5678):\n"
            errorMessage += "1. Que le workflow est importÃ©\n"
            errorMessage += "2. Que le workflow est ACTIVÃ‰ (toggle vert)\n"
            errorMessage += "3. Que le webhook a le path 'formulaire-doc'\n"
            errorMessage += "4. Ouvrez n8n â†’ Workflows â†’ Activez le workflow 'gpt_generator'"
          } else {
            errorMessage += errorText || "Erreur inconnue"
          }
          
          msg.textContent = errorMessage
          msg.style.whiteSpace = "pre-line"
          msg.style.color = "#dc2626"
          return
        }

        const result = await res.json()
        const previewWindow = window.open('', '_blank', 'width=900,height=700')
        previewWindow.document.write(result.html)
        previewWindow.document.close()
        msg.textContent = "PrÃ©visualisation ouverte. Cliquez sur 'Valider et envoyer' dans la nouvelle fenÃªtre."
      } catch (err) {
        console.error(err)
        msg.textContent = `Erreur: ${err.message}. VÃ©rifiez que le serveur de formulaire est dÃ©marrÃ© et que n8n fonctionne.`
      }
    })

    closeModal.addEventListener("click", () => {
      previewModal.classList.add("hidden")
    })
  </script>

</body>
</html>
