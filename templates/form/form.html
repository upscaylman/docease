<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Génération de document</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * {
      font-family: 'Roboto', sans-serif;
    }

    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    body {
      background: linear-gradient(-45deg, #6750A4, #ff0055, #5E35B1, #4686ff);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }

    /* Material Design 3 - Elevation */
    .elevation-1 {
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.3), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
    }

    .elevation-2 {
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.3), 0 2px 6px 2px rgba(0, 0, 0, 0.15);
    }

    .elevation-3 {
      box-shadow: 0 4px 8px 3px rgba(0, 0, 0, 0.15), 0 1px 3px 0 rgba(0, 0, 0, 0.3);
    }

    /* Material Design 3 - Inputs */
    .md3-input {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid #79747E;
      border-radius: 50px;
    }

    .md3-input:focus {
      outline: none;
      border: 2px solid #6750A4;
      border-radius: 50px;
    }

    .md3-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='%236750A4' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
    }

    /* Inputs dans les 3 sections - arrondi max */
    #coordonneesFields input,
    #coordonneesFields select,
    #coordonneesFields textarea,
    #contenuFields input,
    #contenuFields select,
    #contenuFields textarea,
    #expediteurFields input,
    #expediteurFields select,
    #expediteurFields textarea {
      border-radius: 50px !important;
    }

    /* Textarea avec arrondi adapté */
    #coordonneesFields textarea,
    #contenuFields textarea,
    #expediteurFields textarea {
      border-radius: 24px !important;
    }

    /* Material Design 3 - Buttons */
    .md3-button {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 20px;
      font-weight: 500;
      letter-spacing: 0.1px;
      text-transform: none;
    }

    .md3-button:hover {
      box-shadow: 0 1px 3px 1px rgba(0, 0, 0, 0.15), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    }

    .md3-button:active {
      transform: scale(0.98);
    }

    /* Material Design 3 - Cards */
    .md3-card {
      border-radius: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .md3-card:hover {
      transform: translateY(-2px);
    }

    /* Email chips */
    .email-chip {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .email-chip:hover {
      background-color: #E8DEF8;
    }

    /* Onglets de navigation - Material Design 3 Expressive */
    .tab-button {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border-radius: 16px;
      overflow: hidden;
    }

    .tab-button::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(103, 80, 164, 0.1) 0%, rgba(126, 87, 194, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .tab-button:hover::before {
      opacity: 1;
    }

    .tab-button.active {
      background: linear-gradient(135deg, #6750A4 0%, #7E57C2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(103, 80, 164, 0.4);
      transform: translateX(4px);
    }

    .tab-button:not(.active):hover {
      background-color: #F3EDF7;
      transform: translateX(2px);
    }

    .tab-section {
      display: none;
      animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .tab-section.active {
      display: block;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .step-indicator {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 2px solid transparent;
    }

    .step-indicator.completed {
      background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
      border: 2px solid white;
    }

    .step-indicator.active {
      background: linear-gradient(135deg, #6750A4 0%, #7E57C2 100%);
      color: white;
      transform: scale(1.15);
      box-shadow: 0 6px 16px rgba(103, 80, 164, 0.5);
      border: 2px solid white;
    }

    /* Hauteur adaptative selon le device */
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #docForm {
      max-height: calc(100vh - 32px);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #6750A4 #E8DEF8;
    }

    #docForm::-webkit-scrollbar {
      width: 8px;
    }

    #docForm::-webkit-scrollbar-track {
      background: #E8DEF8;
      border-radius: 10px;
    }

    #docForm::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #6750A4 0%, #7E57C2 100%);
      border-radius: 10px;
    }

    #docForm::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #7E57C2 0%, #6750A4 100%);
    }

    /* Responsive - Mobile First */
    @media (max-width: 768px) {
      body {
        padding: 8px;
        align-items: flex-start;
      }

      #docForm {
        max-height: calc(100vh - 16px);
        padding: 16px !important;
      }

      .tab-navigation {
        flex-direction: row !important;
        width: 100% !important;
        overflow-x: auto;
        gap: 8px !important;
        padding-bottom: 8px;
        scrollbar-width: thin;
      }

      .tab-button {
        flex: 1;
        min-width: 100px;
        padding: 12px 8px !important;
        font-size: 11px !important;
        flex-direction: column !important;
        gap: 4px !important;
      }

      .tab-button.active {
        transform: translateY(-4px) !important;
      }

      .tab-button:not(.active):hover {
        transform: translateY(-2px) !important;
      }



      .tab-button-text {
        font-size: 10px;
        text-align: center;
      }

      .step-indicator {
        width: 28px !important;
        height: 28px !important;
        font-size: 12px !important;
      }

      #tabsContainer {
        flex-direction: column !important;
        gap: 16px !important;
      }

      .section-title {
        font-size: 18px !important;
      }

      .section-fields {
        grid-template-columns: 1fr !important;
      }

      .md3-button {
        padding: 12px 16px !important;
        font-size: 14px !important;
      }

      .section-card {
        padding: 16px !important;
      }
    }

    /* Réduire les espacements globaux */
    @media (max-width: 768px) {
      #docForm {
        padding: 12px !important;
      }

      .section-card {
        margin-top: 12px !important;
        margin-bottom: 12px !important;
      }
    }

    /* Tablette */
    @media (min-width: 769px) and (max-width: 1024px) {
      #docForm {
        max-height: calc(100vh - 48px);
      }

      .section-fields {
        grid-template-columns: 1fr !important;
      }
    }

    /* Desktop large */
    @media (min-width: 1440px) {
      #docForm {
        max-height: calc(100vh - 64px);
      }
    }

    /* Cartes de section avec style expressif */
    .section-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 245, 252, 0.95) 100%);
      border-radius: 24px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(103, 80, 164, 0.08);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(103, 80, 164, 0.1);
    }

    .section-card:hover {
      box-shadow: 0 8px 32px rgba(103, 80, 164, 0.15);
      transform: translateY(-4px);
      border-color: rgba(103, 80, 164, 0.2);
    }

    /* Section cards avec style Material Design 3 */
    .section-card {
      background: linear-gradient(135deg, #FFFFFF 0%, #F8F9FA 100%);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .section-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    /* Navigation responsive */
    @media (max-width: 768px) {
      .tabs-layout {
        flex-direction: column;
      }

      .tabs-sidebar {
        width: 100% !important;
        margin-bottom: 1.5rem;
      }

      .tabs-sidebar .sticky {
        position: relative !important;
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
      }

      .tab-button {
        flex: 1;
        min-width: 120px;
        padding: 0.75rem 1rem !important;
      }

      .tab-button span:last-child {
        display: none;
      }

      .tab-button.active::after {
        left: 50%;
        top: auto;
        bottom: 0;
        transform: translateX(-50%);
        width: 60%;
        height: 4px;
      }

      .section-card {
        padding: 1.5rem;
      }

      #coordonneesFields,
      #contenuFields,
      #expediteurFields {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-start min-h-screen py-8 px-4">

  <form id="docForm" class="bg-white p-6 md:p-10 md3-card elevation-3 w-full max-w-7xl space-y-8 rounded-3xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-[#6750A4] to-[#7E57C2] rounded-3xl mb-4 elevation-2">
        <span class="material-icons text-5xl text-white">description</span>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold text-[#1C1B1F] mb-3 bg-gradient-to-r from-[#6750A4] to-[#7E57C2] bg-clip-text text-transparent">Génération de document</h1>
      <p class="text-[#49454F] text-lg md:text-xl">Créez vos documents professionnels en quelques clics</p>
    </div>

    <!-- Actions rapides -->
    <div class="flex gap-3 justify-center mb-8">
      <button type="button" id="fillTestData" class="md3-button px-6 py-3 bg-[#E8DEF8] text-[#6750A4] hover:bg-[#D0BCFF] elevation-2 flex items-center gap-2 rounded-full font-semibold transition-all hover:scale-105">
        <span class="material-icons text-xl">casino</span>
        <span class="hidden sm:inline">Remplir avec données de test</span>
        <span class="sm:hidden">Test</span>
      </button>
    </div>

    <!-- Sélecteur de template -->
    <div class="mb-8 section-card">
      <label class="block text-lg font-semibold text-[#1C1B1F] mb-4 flex items-center gap-3">
        <span class="material-icons text-2xl text-[#6750A4]">description</span>
        Type de document <span class="text-red-500">*</span>
      </label>
      <select id="template" class="md3-input md3-select w-full p-4 text-base rounded-xl border-2 border-[#E8DEF8] focus:border-[#6750A4] transition-all" required>
        <option value="">📄 Choisir un type de document...</option>
      </select>
    </div>

    <!-- Layout avec onglets à gauche et contenu à droite -->
    <div id="tabsContainer" class="flex flex-col md:flex-row gap-6" style="display: none;">
      <!-- Navigation par onglets (gauche sur desktop, horizontal sur mobile) -->
      <div class="w-full md:w-64 flex-shrink-0">
        <div class="tab-navigation md:sticky md:top-4 flex flex-row md:flex-col gap-2 overflow-x-auto md:overflow-x-visible">
          <button type="button" class="tab-button active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-sm font-medium text-[#49454F]" data-tab="coordonnees">
            <span class="step-indicator active w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold bg-gray-200">1</span>
            <span class="tab-button-text">Coordonnées</span>
          </button>
          <button type="button" class="tab-button w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-sm font-medium text-[#49454F]" data-tab="contenu">
            <span class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold bg-gray-200">2</span>
            <span class="tab-button-text">Contenu</span>
          </button>
          <button type="button" class="tab-button w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-sm font-medium text-[#49454F]" data-tab="expediteur">
            <span class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold bg-gray-200">3</span>
            <span class="tab-button-text">Expéditeur</span>
          </button>
        </div>
      </div>

      <!-- Contenu des onglets (droite) -->
      <div class="flex-1 min-w-0">
        <!-- Section Coordonnées -->
        <div id="tab-coordonnees" class="tab-section active section-card">
          <h3 class="section-title text-xl font-bold text-[#1C1B1F] mb-4 flex items-center gap-2">
            <span class="material-icons text-2xl text-[#6750A4]">person</span>
            Coordonnées
          </h3>
          <div id="coordonneesFields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- Section Contenu -->
        <div id="tab-contenu" class="tab-section section-card">
          <h3 class="section-title text-xl font-bold text-[#1C1B1F] mb-4 flex items-center gap-2">
            <span class="material-icons text-2xl text-[#6750A4]">article</span>
            Contenu de la demande
          </h3>
          <div id="contenuFields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- Section Expéditeur -->
        <div id="tab-expediteur" class="tab-section section-card">
          <h3 class="section-title text-xl font-bold text-[#1C1B1F] mb-4 flex items-center gap-2">
            <span class="material-icons text-2xl text-[#6750A4]">send</span>
            Expéditeur
          </h3>
          <div id="expediteurFields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- Navigation entre les onglets -->
        <div class="flex flex-col sm:flex-row justify-between gap-3 mt-8 pt-6 border-t-2 border-[#E8DEF8]">
          <button type="button" id="prevBtn" class="md3-button px-6 py-3 bg-gray-200 text-gray-700 hover:bg-gray-300 elevation-2 flex items-center justify-center gap-2 rounded-full font-semibold transition-all" style="display: none;">
            <span class="material-icons">arrow_back</span>
            <span class="hidden sm:inline">Précédent</span>
          </button>
          <button type="button" id="nextBtn" class="md3-button px-6 py-3 bg-gradient-to-r from-[#6750A4] to-[#7E57C2] text-white hover:shadow-lg elevation-2 flex items-center justify-center gap-2 rounded-full font-semibold transition-all ml-auto">
            <span class="hidden sm:inline">Suivant</span>
            <span class="material-icons">arrow_forward</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Destinataires (après les onglets) -->
    <div id="destinatairesSection" class="w-full mt-6 section-card" style="display: none;">
      <label class="block text-base font-semibold text-[#1C1B1F] mb-3 flex items-center gap-2">
        <span class="material-icons text-xl text-[#6750A4]">email</span>
        Destinataires <span class="text-red-500">*</span>
      </label>
      <div id="emailContainer" class="md3-input w-full p-3 bg-white flex flex-wrap gap-2 items-center min-h-[52px] cursor-text rounded-xl border-2 border-[#E8DEF8] focus-within:border-[#6750A4] transition-all">
        <input id="emailInput" type="text" placeholder="Tapez une adresse email et appuyez sur virgule ou espace..." class="flex-1 outline-none min-w-[200px] text-base">
      </div>
      <input id="destinataires" type="hidden" required>
    </div>

    <!-- Bouton d'action -->
    <div id="previewBtnContainer" class="flex gap-3 mt-6" style="display: none;">
      <button type="button" id="previewBtn" disabled class="md3-button w-full py-3.5 bg-gradient-to-r from-[#6750A4] to-[#7E57C2] text-white hover:shadow-2xl elevation-3 flex items-center justify-center gap-2 text-base font-bold rounded-2xl disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-none transition-all transform hover:scale-105 active:scale-95">
        <span class="material-icons">visibility</span>
        Prévisualiser le document
      </button>
    </div>

    <p id="message" class="text-center text-[#49454F] text-sm"></p>
  </form>

  <!-- Modal de prévisualisation Material Design 3 -->
  <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 backdrop-blur-sm">
    <div class="bg-white md3-card elevation-3 w-full max-w-6xl max-h-[90vh] overflow-hidden relative m-4 flex flex-col">
      <!-- Header du modal -->
      <div class="flex items-center justify-between p-6 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <span class="material-icons text-[#6750A4] text-3xl">preview</span>
          <div>
            <h2 class="text-2xl font-bold text-[#1C1B1F]">Prévisualisation du document</h2>
            <p class="text-sm text-[#49454F]" id="previewSubtitle">Vérifiez les informations avant génération</p>
          </div>
        </div>
        <button id="closeModal" class="text-[#49454F] hover:text-[#1C1B1F] transition-colors md3-button p-2 rounded-full hover:bg-gray-100">
          <span class="material-icons text-3xl">close</span>
        </button>
      </div>

      <!-- Contenu scrollable -->
      <div class="flex-1 overflow-auto p-6">
        <div id="previewContent"></div>
      </div>

      <!-- Footer avec actions -->
      <div class="flex items-center justify-between gap-3 p-6 border-t border-gray-200 bg-gray-50">
        <button id="closeModalBtn" class="md3-button px-6 py-2.5 bg-gray-200 text-[#1C1B1F] hover:bg-gray-300 elevation-1 flex items-center gap-2">
          <span class="material-icons">close</span>
          Fermer
        </button>
        <div class="flex gap-3">
          <button id="downloadWordBtn" class="md3-button px-6 py-2.5 bg-[#E8DEF8] text-[#6750A4] hover:bg-[#D0BCFF] elevation-1 flex items-center gap-2" disabled>
            <span class="material-icons">download</span>
            Télécharger le document
          </button>
          <!-- Bouton d'envoi par email désactivé temporairement -->
          <!-- <button id="sendEmailBtn" class="md3-button px-6 py-2.5 bg-[#6750A4] text-white hover:bg-[#7E57C2] elevation-2 flex items-center gap-2">
            <span class="material-icons">send</span>
            Générer et envoyer
          </button> -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour afficher le document Word -->
  <div id="wordViewerModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-[60] backdrop-blur-sm">
    <div class="bg-white md3-card elevation-3 w-full max-w-7xl h-[95vh] overflow-hidden relative m-4 flex flex-col">
      <!-- Header du modal Word -->
      <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-[#6750A4]">
        <div class="flex items-center gap-3">
          <span class="material-icons text-white text-2xl">description</span>
          <div>
            <h2 class="text-xl font-bold text-white">Aperçu du document Word</h2>
            <p class="text-sm text-white opacity-90" id="wordViewerSubtitle">Génération en cours...</p>
          </div>
        </div>
        <button id="closeWordViewer" class="text-white hover:bg-white hover:bg-opacity-20 transition-colors md3-button p-2 rounded-full">
          <span class="material-icons text-2xl">close</span>
        </button>
      </div>

      <!-- Contenu iframe -->
      <div class="flex-1 overflow-hidden relative bg-gray-100">
        <div id="wordViewerLoading" class="absolute inset-0 flex items-center justify-center bg-white z-10">
          <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-[#6750A4] border-t-transparent mb-4"></div>
            <p class="text-[#49454F] text-lg font-medium">Génération du document Word...</p>
            <p class="text-[#49454F] text-sm mt-2">Cela peut prendre quelques secondes</p>
          </div>
        </div>
        <iframe id="wordViewerFrame" class="w-full h-full border-0" style="display:none;"></iframe>
      </div>

      <!-- Footer avec actions -->
      <div class="flex items-center justify-between gap-3 p-4 border-t border-gray-200 bg-gray-50">
        <div class="text-sm text-[#49454F]">
          <span class="material-icons text-base align-middle mr-1">info</span>
          Le document est généré par n8n et affiché via Google Docs Viewer
        </div>
        <div class="flex gap-3">
          <button id="downloadWordBtn" class="md3-button px-6 py-2.5 bg-[#E8DEF8] text-[#6750A4] hover:bg-[#D0BCFF] elevation-1 flex items-center gap-2" disabled>
            <span class="material-icons">download</span>
            Télécharger
          </button>
          <button id="closeWordViewerBtn" class="md3-button px-6 py-2.5 bg-gray-200 text-[#1C1B1F] hover:bg-gray-300 elevation-1 flex items-center gap-2">
            <span class="material-icons">close</span>
            Fermer
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("docForm")
    const msg = document.getElementById("message")
    const previewModal = document.getElementById("previewModal")
    const previewContent = document.getElementById("previewContent")
    const closeModal = document.getElementById("closeModal")
    const templateSelect = document.getElementById("template")
    const dynamicFields = document.getElementById("dynamicFields")
    
    let variablesConfig = null
    let currentTemplate = null

    // Charger variables.json au démarrage
    async function loadVariablesConfig() {
      try {
        const response = await fetch('/config/variables.json')
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }
        
        const text = await response.text()
        if (!text || text.trim() === '') {
          throw new Error('Empty response from server')
        }
        
        variablesConfig = JSON.parse(text)
        
        // Remplir le sélecteur de templates
        templateSelect.innerHTML = '<option value="">📄 Choisir un type de document...</option>'
        Object.keys(variablesConfig.templates).forEach(key => {
          const template = variablesConfig.templates[key]
          const option = document.createElement('option')
          option.value = key
          option.textContent = template.nom
          templateSelect.appendChild(option)
        })
        
        console.log('Variables config loaded:', variablesConfig)
      } catch (error) {
        console.error('Erreur chargement variables.json:', error)
        msg.textContent = `❌ Impossible de charger la configuration: ${error.message}`
        msg.style.color = '#dc2626'
      }
    }

    // Générer les champs dynamiquement dans les onglets
    function generateFields(templateKey) {
      if (!variablesConfig) return

      currentTemplate = templateKey

      const template = variablesConfig.templates[templateKey]
      if (!template) return

      // Afficher le conteneur des onglets
      document.getElementById('tabsContainer').style.display = 'flex'
      document.getElementById('destinatairesSection').style.display = 'block'
      document.getElementById('previewBtnContainer').style.display = 'flex'

      // Vider les conteneurs
      document.getElementById('coordonneesFields').innerHTML = ''
      document.getElementById('contenuFields').innerHTML = ''
      document.getElementById('expediteurFields').innerHTML = ''

      // === SECTION 1: COORDONNÉES ===
      const coordFields = ['entreprise', 'codeDocument', 'civiliteDestinataire', 'nomDestinataire', 'statutDestinataire', 'batiment', 'adresse', 'cpVille']
      const coordContainer = document.getElementById('coordonneesFields')

      coordFields.forEach(key => {
        const variable = variablesConfig.variables_communes[key]
        if (variable && variable.type !== 'auto') {
          const field = createField(key, variable)
          if (field) coordContainer.appendChild(field)
        }
      })

      // === SECTION 2: CONTENU DE LA DEMANDE ===
      const contenuContainer = document.getElementById('contenuFields')

      if (template.variables_specifiques) {
        Object.keys(template.variables_specifiques).forEach(key => {
          const variable = template.variables_specifiques[key]
          const field = createField(key, variable)
          if (field) contenuContainer.appendChild(field)
        })
      }

      // === SECTION 3: EXPÉDITEUR ===
      const expediteurFields = ['signatureExp']
      const expediteurContainer = document.getElementById('expediteurFields')

      expediteurFields.forEach(key => {
        const variable = variablesConfig.variables_communes[key]
        if (variable && variable.type !== 'auto') {
          const field = createField(key, variable)
          if (field) expediteurContainer.appendChild(field)
        }
      })

      // Réinitialiser la navigation des onglets
      switchTab('coordonnees')
    }

    // Créer un champ HTML depuis la config
    function createField(key, config) {
      const fieldContainer = document.createElement('div')
      fieldContainer.className = 'w-full'

      const label = document.createElement('label')
      label.htmlFor = key
      label.className = 'block text-xs font-medium text-gray-700 mb-1.5'
      label.innerHTML = config.label + (config.required ? ' <span class="text-red-500">*</span>' : '')
      fieldContainer.appendChild(label)

      if (config.type === 'select') {
        const select = document.createElement('select')
        select.id = key
        select.className = 'md3-input md3-select w-full p-2.5 text-sm bg-white'
        select.required = config.required || false

        const defaultOption = document.createElement('option')
        defaultOption.value = ''
        defaultOption.textContent = `Choisir...`
        select.appendChild(defaultOption)

        config.options.forEach(opt => {
          const option = document.createElement('option')
          option.value = opt
          option.textContent = opt
          select.appendChild(option)
        })

        fieldContainer.appendChild(select)
        return fieldContainer
      } else if (config.type === 'textarea') {
        const textarea = document.createElement('textarea')
        textarea.id = key
        textarea.placeholder = config.placeholder || config.label
        textarea.rows = config.rows || 3
        textarea.className = 'md3-input w-full p-2.5 text-sm resize-none'
        textarea.required = config.required || false
        fieldContainer.appendChild(textarea)
        return fieldContainer
      } else {
        const input = document.createElement('input')
        input.id = key
        input.type = config.type === 'email' ? 'email' : 'text'
        input.placeholder = config.placeholder || config.label
        input.className = 'md3-input w-full p-2.5 text-sm'
        input.required = config.required || false
        if (config.default) input.value = config.default
        fieldContainer.appendChild(input)
        return fieldContainer
      }
    }

    // Fonction pour vérifier si tous les champs required sont remplis
    function checkRequiredFields() {
      const previewBtn = document.getElementById('previewBtn')

      // Vérifier si un template est sélectionné
      if (!templateSelect.value) {
        previewBtn.disabled = true
        console.log('❌ Bouton désactivé : aucun template sélectionné')
        return
      }

      // Vérifier le champ destinataires (email)
      const destinataires = document.getElementById('destinataires')
      if (!destinataires || !destinataires.value || destinataires.value.trim() === '') {
        previewBtn.disabled = true
        console.log('❌ Bouton désactivé : aucun destinataire')
        return
      }

      // Récupérer tous les champs required dans les 3 sections
      const requiredFields = document.querySelectorAll('#coordonneesFields [required], #contenuFields [required], #expediteurFields [required]')
      let allFilled = true
      const emptyFields = []

      requiredFields.forEach(field => {
        if (!field.value || field.value.trim() === '') {
          allFilled = false
          emptyFields.push(field.id || field.name || 'champ sans nom')
        }
      })

      if (!allFilled) {
        previewBtn.disabled = true
        console.log('❌ Bouton désactivé : champs vides ->', emptyFields)
      } else {
        previewBtn.disabled = false
        console.log('✅ Bouton activé : tous les champs required sont remplis')
      }
    }

    // Navigation entre les onglets
    let currentTab = 'coordonnees'
    const tabs = ['coordonnees', 'contenu', 'expediteur']

    function switchTab(tabName) {
      currentTab = tabName
      const currentIndex = tabs.indexOf(tabName)

      // Mettre à jour les boutons d'onglets
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active')
        btn.querySelector('.step-indicator').classList.remove('active')
      })
      const activeBtn = document.querySelector(`[data-tab="${tabName}"]`)
      activeBtn.classList.add('active')
      activeBtn.querySelector('.step-indicator').classList.add('active')

      // Mettre à jour les sections
      document.querySelectorAll('.tab-section').forEach(section => {
        section.classList.remove('active')
      })
      document.getElementById(`tab-${tabName}`).classList.add('active')

      // Mettre à jour les boutons Précédent/Suivant
      const prevBtn = document.getElementById('prevBtn')
      const nextBtn = document.getElementById('nextBtn')

      if (currentIndex === 0) {
        prevBtn.style.display = 'none'
      } else {
        prevBtn.style.display = 'flex'
      }

      if (currentIndex === tabs.length - 1) {
        nextBtn.style.display = 'none'
      } else {
        nextBtn.style.display = 'flex'
      }
    }

    // Clic sur les onglets
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab(btn.dataset.tab)
      })
    })

    // Bouton Précédent
    document.getElementById('prevBtn').addEventListener('click', () => {
      const currentIndex = tabs.indexOf(currentTab)
      if (currentIndex > 0) {
        switchTab(tabs[currentIndex - 1])
      }
    })

    // Bouton Suivant
    document.getElementById('nextBtn').addEventListener('click', () => {
      const currentIndex = tabs.indexOf(currentTab)
      if (currentIndex < tabs.length - 1) {
        switchTab(tabs[currentIndex + 1])
      }
    })

    // Détecter changement de template
    templateSelect.addEventListener('change', (e) => {
      if (e.target.value) {
        generateFields(e.target.value)

        // Ajouter des listeners sur tous les champs pour vérifier la validation
        setTimeout(() => {
          const allInputs = document.querySelectorAll('#coordonneesFields input, #coordonneesFields select, #coordonneesFields textarea, #contenuFields input, #contenuFields select, #contenuFields textarea, #expediteurFields input, #expediteurFields select, #expediteurFields textarea')
          allInputs.forEach(input => {
            input.addEventListener('input', checkRequiredFields)
            input.addEventListener('change', checkRequiredFields)
          })

          // Ajouter listener sur le champ destinataires aussi
          const destinataires = document.getElementById('destinataires')
          if (destinataires) {
            destinataires.addEventListener('input', checkRequiredFields)
            destinataires.addEventListener('change', checkRequiredFields)
          }

          checkRequiredFields()
        }, 100)
      } else {
        document.getElementById('tabsContainer').style.display = 'none'
        document.getElementById('destinatairesSection').style.display = 'none'
        document.getElementById('previewBtnContainer').style.display = 'none'
        document.getElementById('previewBtn').disabled = true
      }
    })

    // Charger la config au démarrage
    loadVariablesConfig()
    
    // Gestion des chips d'emails inline
    const emailInput = document.getElementById("emailInput")
    const emailContainer = document.getElementById("emailContainer")
    const destinatairesHidden = document.getElementById("destinataires")
    let emails = []
    
    function createChip(email) {
      const chip = document.createElement('div')
      chip.className = 'email-chip flex items-center gap-1.5 bg-[#E8DEF8] text-[#21005D] px-3 py-1.5 rounded-full text-sm font-medium elevation-1'
      chip.innerHTML = `
        <span class="material-icons text-base">email</span>
        <span>${email}</span>
        <button type="button" class="ml-1 text-[#6750A4] hover:text-[#21005D] transition-colors">
          <span class="material-icons text-base">close</span>
        </button>
      `
      chip.querySelector('button').addEventListener('click', () => {
        const index = emails.indexOf(email)
        if (index > -1) {
          emails.splice(index, 1)
          chip.remove()
          updateHiddenField()
        }
      })
      return chip
    }
    
    function updateHiddenField() {
      destinatairesHidden.value = emails.join(', ')
      checkRequiredFields()
    }
    
    function addEmail(email) {
      email = email.trim()
      if (email && email.includes('@') && !emails.includes(email)) {
        emails.push(email)
        const chip = createChip(email)
        emailContainer.insertBefore(chip, emailInput)
        updateHiddenField()
        return true
      }
      return false
    }
    
    emailInput.addEventListener('input', (e) => {
      const value = e.target.value
      if (value.includes(',') || value.includes(';') || value.includes(' ')) {
        const parts = value.split(/[,;\s]+/)
        parts.forEach(part => {
          if (part.trim()) {
            addEmail(part)
          }
        })
        emailInput.value = ''
      }
    })
    
    emailInput.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && emailInput.value === '' && emails.length > 0) {
        emails.pop()
        const chips = emailContainer.querySelectorAll('div')
        if (chips.length > 0) {
          chips[chips.length - 1].remove()
        }
        updateHiddenField()
      }
      if (e.key === 'Enter') {
        e.preventDefault()
        if (emailInput.value.trim()) {
          addEmail(emailInput.value)
          emailInput.value = ''
        }
      }
    })
    
    emailContainer.addEventListener('click', () => {
      emailInput.focus()
    })
    
    // Bouton pour remplir avec des données de test
    document.getElementById('fillTestData').addEventListener('click', () => {
      // Sélectionner un template aléatoire si pas déjà sélectionné
      if (!templateSelect.value && variablesConfig) {
        const templates = Object.keys(variablesConfig.templates)
        const randomTemplate = templates[Math.floor(Math.random() * templates.length)]
        templateSelect.value = randomTemplate
        generateFields(randomTemplate)
      }

      const testData = {
        entreprise: ['ACME Corp', 'TechCo Industries', 'Solutions SARL', 'Métallurgie SA'][Math.floor(Math.random() * 4)],
        codeDocument: ['DOC-2024-001', 'REF-2024-042', 'NUM-2024-123', 'CODE-2024-789'][Math.floor(Math.random() * 4)],
        civiliteDestinataire: ['Monsieur', 'Madame'][Math.floor(Math.random() * 2)],
        statutDestinataire: ['Président', 'Directeur', 'Responsable RH', 'Chef de service'][Math.floor(Math.random() * 4)],
        batiment: ['Bâtiment A', 'Bâtiment B', 'Tour Nord', 'Annexe'][Math.floor(Math.random() * 4)],
        adresse: ['123 Rue de la Paix', '45 Avenue des Champs', '78 Boulevard Saint-Michel', '12 Place de la République'][Math.floor(Math.random() * 4)],
        cpVille: ['75001 Paris', '69002 Lyon', '13001 Marseille', '44000 Nantes'][Math.floor(Math.random() * 4)],
        numeroCourrier: ['2025-' + String(Math.floor(Math.random() * 100) + 1).padStart(3, '0')],
        civiliteRemplace: ['Monsieur', 'Madame'][Math.floor(Math.random() * 2)],
        nomRemplace: ['Durand', 'Petit', 'Robert', 'Moreau'][Math.floor(Math.random() * 4)],
        civiliteDelegue: ['Monsieur', 'Madame'][Math.floor(Math.random() * 2)],
        nomDelegue: ['Lefebvre', 'Girard', 'Rousseau', 'Leroy'][Math.floor(Math.random() * 4)],
        emailDelegue: ['lefebvre@example.com', 'girard@example.com', 'rousseau@example.com'][Math.floor(Math.random() * 3)],
        signatureExp: ['FO METAUX', 'Force Ouvrière', 'Syndicat FO'][Math.floor(Math.random() * 3)],
        emails: ['epheandrill@gmail.com', 'bouvier.jul@gmail.com']
      }
      
      // Remplir tous les champs dynamiques
      Object.keys(testData).forEach(key => {
        if (key === 'emails') return // Géré séparément
        const field = document.getElementById(key)
        if (field) field.value = testData[key]
      })
      
      // Remplir les emails avec chips
      emails = []
      emailContainer.querySelectorAll('div').forEach(chip => chip.remove())
      testData.emails.forEach(email => addEmail(email))
    })



    closeModal.addEventListener("click", () => {
      previewModal.classList.add("hidden")
    })

    document.getElementById("closeModalBtn").addEventListener("click", () => {
      previewModal.classList.add("hidden")
    })

    // Fonction pour générer la prévisualisation locale
    function generateLocalPreview() {
      if (!templateSelect.value) {
        msg.textContent = "⚠️ Veuillez sélectionner un type de document"
        msg.style.color = "#dc2626"
        return
      }

      // Collecter les données du formulaire depuis les 3 sections
      const data = {
        templateType: templateSelect.value,
        emailDestinataire: document.getElementById("destinataires").value
      }

      const allInputs = document.querySelectorAll('#coordonneesFields input, #coordonneesFields select, #coordonneesFields textarea, #contenuFields input, #contenuFields select, #contenuFields textarea, #expediteurFields input, #expediteurFields select, #expediteurFields textarea')
      allInputs.forEach(input => {
        data[input.id] = input.value || ''
      })

      // Générer la date actuelle
      const now = new Date()
      const dateStr = now.toLocaleDateString('fr-FR')
      const dateCompleteStr = now.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' })

      // Déterminer le type de document
      const templateConfig = variablesConfig.templates[data.templateType]
      const typeDocumentLabel = templateConfig ? templateConfig.nom : 'Document'

      // Générer le HTML de prévisualisation
      const previewHTML = `
        <div class="bg-white rounded-lg">
          <!-- En-tête du document -->
          <div class="text-center mb-6 pb-4 border-b-2 border-[#6750A4]">
            <div class="text-sm text-[#49454F] mb-2">Paris, le <strong class="text-[#6750A4]">${dateStr}</strong></div>
            <div class="text-xl font-bold text-[#6750A4]">${typeDocumentLabel}</div>
          </div>

          <!-- Grille 3 colonnes -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">

            <!-- Colonne 1: Coordonnées (Bleu) -->
            <div class="md3-card elevation-1 p-5 bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500">
              <h3 class="text-base font-semibold text-blue-900 mb-4 flex items-center gap-2">
                <span class="material-icons">location_on</span> Coordonnées
              </h3>
              <div class="space-y-2 text-sm">
                ${data.entreprise ? `<div><span class="font-semibold text-blue-900">Entreprise:</span> <strong class="text-blue-700">${data.entreprise}</strong></div>` : ''}
                ${data.codeDocument ? `<div><span class="font-semibold text-blue-900">Code:</span> <strong class="text-blue-700">${data.codeDocument}</strong></div>` : ''}
                ${data.civiliteDestinataire ? `<div><span class="font-semibold text-blue-900">Civilité:</span> <strong class="text-blue-700">${data.civiliteDestinataire}</strong></div>` : ''}
                ${data.nomDestinataire ? `<div><span class="font-semibold text-blue-900">Nom:</span> <strong class="text-blue-700">${data.nomDestinataire}</strong></div>` : ''}
                ${data.statutDestinataire ? `<div><span class="font-semibold text-blue-900">Statut:</span> <strong class="text-blue-700">${data.statutDestinataire}</strong></div>` : ''}
                ${data.batiment ? `<div><span class="font-semibold text-blue-900">Bâtiment:</span> <strong class="text-blue-700">${data.batiment}</strong></div>` : ''}
                ${data.adresse ? `<div><span class="font-semibold text-blue-900">Adresse:</span> <strong class="text-blue-700">${data.adresse}</strong></div>` : ''}
                ${data.cpVille ? `<div><span class="font-semibold text-blue-900">CP/Ville:</span> <strong class="text-blue-700">${data.cpVille}</strong></div>` : ''}
              </div>
            </div>

            <!-- Colonne 2: Informations spécifiques (Vert) -->
            <div class="md3-card elevation-1 p-5 bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-500">
              <h3 class="text-base font-semibold text-green-900 mb-4 flex items-center gap-2">
                <span class="material-icons">edit_document</span> Contenu de la demande
              </h3>
              <div class="space-y-2 text-sm">
                ${data.numeroCourrier ? `<div><span class="font-semibold text-green-900">N° Courrier:</span> <strong class="text-green-700">${data.numeroCourrier}</strong></div>` : ''}
                ${data.objet ? `<div><span class="font-semibold text-green-900">Objet:</span> <strong class="text-green-700">${data.objet}</strong></div>` : ''}
                ${data.civiliteDelegue ? `<div><span class="font-semibold text-green-900">Civilité Délégué:</span> <strong class="text-green-700">${data.civiliteDelegue}</strong></div>` : ''}
                ${data.nomDelegue ? `<div><span class="font-semibold text-green-900">Nom Délégué:</span> <strong class="text-green-700">${data.nomDelegue}</strong></div>` : ''}
                ${data.emailDelegue ? `<div><span class="font-semibold text-green-900">Email Délégué:</span> <strong class="text-green-700">${data.emailDelegue}</strong></div>` : ''}
                ${data.civiliteRemplace ? `<div><span class="font-semibold text-green-900">Civilité Remplaçant:</span> <strong class="text-green-700">${data.civiliteRemplace}</strong></div>` : ''}
                ${data.nomRemplace ? `<div><span class="font-semibold text-green-900">Nom Remplaçant:</span> <strong class="text-green-700">${data.nomRemplace}</strong></div>` : ''}
              </div>
            </div>

            <!-- Colonne 3: Expéditeur (Violet) -->
            <div class="md3-card elevation-1 p-5 bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-500">
              <h3 class="text-base font-semibold text-purple-900 mb-4 flex items-center gap-2">
                <span class="material-icons">person</span> Expéditeur
              </h3>
              <div class="space-y-2 text-sm">
                ${data.signatureExp ? `<div><span class="font-semibold text-purple-900">Signature:</span> <strong class="text-purple-700">${data.signatureExp}</strong></div>` : ''}
              </div>
            </div>

          </div>

          <!-- Bloc Destinataires (Orange) - Pleine largeur sous les 3 colonnes -->
          <div class="md3-card elevation-1 p-5 bg-gradient-to-br from-orange-50 to-orange-100 border-l-4 border-orange-500 mb-6">
            <h3 class="text-base font-semibold text-orange-900 mb-4 flex items-center gap-2">
              <span class="material-icons">mail</span> Destinataires
            </h3>
            <div class="flex flex-wrap gap-2">
              ${data.emailDestinataire ? data.emailDestinataire.split(',').map(email => `
                <div class="inline-flex items-center gap-2 px-3 py-2 bg-white rounded-full border border-orange-300 text-orange-700 text-sm">
                  <span class="material-icons text-base">email</span>
                  <span class="font-medium">${email.trim()}</span>
                </div>
              `).join('') : '<div class="text-gray-500 text-sm">Aucun destinataire</div>'}
            </div>
          </div>

          <!-- Pied de page -->
          <div class="mt-6 pt-4 border-t-2 border-gray-200 text-sm text-[#49454F]">
            <p>Je reste à votre disposition pour toute information complémentaire.</p>
            <p class="mt-2">Cordialement,</p>
            ${data.signatureExp ? `<p class="mt-2 font-bold text-[#6750A4]">${data.signatureExp}</p>` : ''}
          </div>

          <!-- Note informative -->
          <div class="mt-6 bg-[#E8DEF8] border-l-4 border-[#6750A4] p-4 rounded">
            <p class="text-sm text-[#21005D]">
              <span class="material-icons text-base align-middle mr-1">info</span>
              <strong>Les données en couleur seront insérées dans le template Word</strong>
            </p>
          </div>
        </div>
      `

      // Afficher dans le modal
      previewContent.innerHTML = previewHTML
      document.getElementById("previewSubtitle").textContent = `Type: ${typeDocumentLabel} • Date: ${dateStr}`

      // Activer le bouton de téléchargement
      document.getElementById("downloadWordBtn").disabled = false

      previewModal.classList.remove("hidden")
    }

    // Bouton de prévisualisation
    document.getElementById("previewBtn").addEventListener("click", generateLocalPreview)

    // Variable globale pour stocker le Word généré
    let generatedWordBase64 = null
    let currentFormData = null

    // Bouton "Télécharger le document" - génère le Word et permet de le télécharger
    document.getElementById("downloadWordBtn").addEventListener("click", async () => {
      const btn = document.getElementById("downloadWordBtn")
      const originalHTML = btn.innerHTML

      try {
        btn.disabled = true
        btn.innerHTML = '<span class="material-icons animate-spin">sync</span> Génération...'

        // Collecter les données du formulaire depuis les 3 sections
        const data = {
          templateType: templateSelect.value,
          emailDestinataire: document.getElementById("destinataires").value
        }

        const allInputs = document.querySelectorAll('#coordonneesFields input, #coordonneesFields select, #coordonneesFields textarea, #contenuFields input, #contenuFields select, #contenuFields textarea, #expediteurFields input, #expediteurFields select, #expediteurFields textarea')
        allInputs.forEach(input => {
          data[input.id] = input.value || ''
        })

        currentFormData = data
        console.log('📤 Génération du Word via formulaire-doc:', data)

        // Appeler le webhook formulaire-doc qui génère le Word et le retourne
        const response = await fetch("http://localhost:5678/webhook/formulaire-doc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })

        if (!response.ok) {
          throw new Error(`Erreur ${response.status}`)
        }

        // Vérifier le type de contenu
        const contentType = response.headers.get('content-type')
        let blob

        if (contentType && contentType.includes('application/json')) {
          // Réponse JSON avec base64
          const result = await response.json()
          console.log('✅ Réponse JSON reçue:', result)

          if (!result.success || !result.data) {
            throw new Error('Fichier Word non trouvé dans la réponse')
          }

          // Stocker le base64 pour l'envoi ultérieur
          generatedWordBase64 = result.data

          // Convertir base64 en blob pour le téléchargement
          const byteCharacters = atob(result.data)
          const byteNumbers = new Array(byteCharacters.length)
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i)
          }
          const byteArray = new Uint8Array(byteNumbers)
          blob = new Blob([byteArray], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' })
        } else {
          // Réponse binaire directe
          console.log('✅ Réponse binaire reçue')
          blob = await response.blob()

          // Convertir le blob en base64 pour l'envoi ultérieur
          const reader = new FileReader()
          generatedWordBase64 = await new Promise((resolve, reject) => {
            reader.onloadend = () => resolve(reader.result.split(',')[1])
            reader.onerror = reject
            reader.readAsDataURL(blob)
          })
        }

        console.log('✅ Word converti en blob:', blob.size, 'octets')

        // Télécharger le Word
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `Document_${data.templateType}_${Date.now()}.docx`
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)

        alert('✅ Document téléchargé ! Vous pouvez maintenant cliquer sur "Générer et envoyer" pour envoyer l\'email.')

        btn.disabled = false
        btn.innerHTML = originalHTML
      } catch (error) {
        console.error("Erreur:", error)
        alert("❌ Erreur lors de la génération : " + error.message)
        btn.disabled = false
        btn.innerHTML = originalHTML
      }
    })

    // Bouton "Générer et envoyer" - envoie l'email avec le Word en pièce jointe
    // DÉSACTIVÉ TEMPORAIREMENT
    /*
    document.getElementById("sendEmailBtn").addEventListener("click", async () => {
      const btn = document.getElementById("sendEmailBtn")
      const originalHTML = btn.innerHTML

      try {
        btn.disabled = true
        btn.innerHTML = '<span class="material-icons animate-spin">sync</span> Envoi en cours...'

        // Si le Word n'a pas été généré, le générer d'abord
        if (!generatedWordBase64) {
          const data = {
            templateType: templateSelect.value,
            emailDestinataire: document.getElementById("destinataires").value
          }

          const allInputs = dynamicFields.querySelectorAll('input, select, textarea')
          allInputs.forEach(input => {
            data[input.id] = input.value || ''
          })

          currentFormData = data
          console.log('� Génération du Word avant envoi:', data)

          // Pas besoin de générer séparément, validate-doc le fera
          currentFormData = data
        }

        // Envoyer l'email avec le Word via validate-doc
        console.log('📧 Envoi email via validate-doc')

        const sendData = {
          ...currentFormData,
          wordfile: generatedWordBase64 || ""
        }

        const sendResponse = await fetch("http://localhost:5678/webhook/validate-doc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(sendData)
        })

        if (!sendResponse.ok) {
          const errorText = await sendResponse.text(); throw new Error(`Erreur ${sendResponse.status}: ${errorText}`)
        }

        const sendResult = await sendResponse.json()
        console.log('📥 Résultat envoi:', sendResult)

        // Fermer le modal
        previewModal.classList.add("hidden")

        // Réinitialiser
        generatedWordBase64 = null
        currentFormData = null

        alert('✅ ' + (sendResult.message || 'Document envoyé par email avec succès !'))

        btn.disabled = false
        btn.innerHTML = originalHTML
      } catch (error) {
        console.error("Erreur:", error)
        alert("❌ Erreur lors de l'envoi : " + error.message)
        btn.disabled = false
        btn.innerHTML = originalHTML
      }
    })
    */

    // Fonction utilitaire pour convertir base64 en Blob
    function base64ToBlob(base64, mimeType) {
      const byteCharacters = atob(base64)
      const byteNumbers = new Array(byteCharacters.length)
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i)
      }
      const byteArray = new Uint8Array(byteNumbers)
      return new Blob([byteArray], { type: mimeType })
    }

    // Variables pour le viewer Word
    const wordViewerModal = document.getElementById("wordViewerModal")
    const wordViewerFrame = document.getElementById("wordViewerFrame")
    const wordViewerLoading = document.getElementById("wordViewerLoading")
    const closeWordViewer = document.getElementById("closeWordViewer")
    const closeWordViewerBtn = document.getElementById("closeWordViewerBtn")
    const downloadWordBtn = document.getElementById("downloadWordBtn")
    let currentWordBlob = null
    let currentWordUrl = null

    // Fonction pour générer et afficher le document Word
    async function generateAndViewWord() {
      if (!templateSelect.value) {
        msg.textContent = "⚠️ Veuillez sélectionner un type de document"
        msg.style.color = "#dc2626"
        return
      }

      // Collecter les données du formulaire
      const data = {
        templateType: templateSelect.value,
        emailDestinataire: document.getElementById("destinataires").value
      }

      const allInputs = dynamicFields.querySelectorAll('input, select, textarea')
      allInputs.forEach(input => {
        data[input.id] = input.value || ''
      })

      console.log('📤 Génération du document Word:', data)

      // Afficher le modal avec loading
      wordViewerModal.classList.remove("hidden")
      wordViewerLoading.style.display = "flex"
      wordViewerFrame.style.display = "none"
      downloadWordBtn.disabled = true

      const templateConfig = variablesConfig.templates[data.templateType]
      const typeDocumentLabel = templateConfig ? templateConfig.nom : 'Document'
      document.getElementById("wordViewerSubtitle").textContent = `Génération de ${typeDocumentLabel}...`

      try {
        // Appel à n8n pour générer le document Word
        const res = await fetch("http://localhost:5678/webhook/formulaire-doc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })

        if (!res.ok) {
          throw new Error(`Erreur ${res.status}: ${await res.text()}`)
        }

        console.log('✅ Document généré, extraction du fichier Word...')

        // Vérifier le type de contenu
        const contentType = res.headers.get('content-type')

        if (contentType && contentType.includes('application/json')) {
          // Réponse JSON avec base64
          const result = await res.json()

          if (!result.success || !result.data) {
            throw new Error('Fichier Word non trouvé dans la réponse')
          }

          const wordBase64 = result.data
          console.log('📄 Fichier Word extrait (JSON base64), taille:', wordBase64.length)

          // Convertir base64 en Blob
          const binaryString = atob(wordBase64)
          const bytes = new Uint8Array(binaryString.length)
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i)
          }
          currentWordBlob = new Blob([bytes], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' })
        } else {
          // Réponse binaire directe
          console.log('📄 Fichier Word extrait (binaire direct)')
          currentWordBlob = await res.blob()
        }

        // Créer une URL pour le blob
        if (currentWordUrl) {
          URL.revokeObjectURL(currentWordUrl)
        }
        currentWordUrl = URL.createObjectURL(currentWordBlob)

        console.log('✅ Blob créé, affichage dans iframe...')

        // Utiliser Google Docs Viewer pour afficher le document
        // Note: Google Docs Viewer nécessite une URL publique, donc on va utiliser Office Online Viewer
        // Ou afficher un message pour télécharger

        // Pour l'instant, on va proposer le téléchargement et afficher un message
        wordViewerLoading.style.display = "none"

        // Créer un message dans l'iframe
        const messageHTML = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
            <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
            <style>
              * { font-family: 'Roboto', sans-serif; }
              body {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                margin: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              }
              .container {
                background: white;
                border-radius: 16px;
                padding: 48px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
              }
              .icon {
                font-size: 80px;
                color: #6750A4;
                margin-bottom: 24px;
              }
              h1 {
                color: #1C1B1F;
                font-size: 28px;
                margin-bottom: 16px;
              }
              p {
                color: #49454F;
                font-size: 16px;
                line-height: 1.6;
                margin-bottom: 32px;
              }
              .btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                background: #6750A4;
                color: white;
                padding: 16px 32px;
                border-radius: 24px;
                text-decoration: none;
                font-weight: 500;
                font-size: 16px;
                transition: all 0.2s;
                box-shadow: 0 4px 12px rgba(103, 80, 164, 0.3);
              }
              .btn:hover {
                background: #7E57C2;
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(103, 80, 164, 0.4);
              }
              .success {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                background: #E8F5E9;
                color: #2E7D32;
                padding: 12px 24px;
                border-radius: 24px;
                margin-bottom: 24px;
                font-weight: 500;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <span class="material-icons icon">check_circle</span>
              <div class="success">
                <span class="material-icons">done</span>
                Document généré avec succès !
              </div>
              <h1>Votre document est prêt</h1>
              <p>
                Le document Word a été généré avec succès.<br>
                Cliquez sur le bouton ci-dessous pour le télécharger et l'ouvrir dans Microsoft Word ou LibreOffice.
              </p>
              <a href="${currentWordUrl}" download="document_${Date.now()}.docx" class="btn">
                <span class="material-icons">download</span>
                Télécharger le document Word
              </a>
            </div>
          </body>
          </html>
        `

        wordViewerFrame.srcdoc = messageHTML
        wordViewerFrame.style.display = "block"

        // Activer le bouton de téléchargement
        downloadWordBtn.disabled = false
        downloadWordBtn.onclick = () => {
          const a = document.createElement('a')
          a.href = currentWordUrl
          a.download = `document_${typeDocumentLabel.replace(/\s+/g, '_')}_${Date.now()}.docx`
          a.click()
        }

        document.getElementById("wordViewerSubtitle").textContent = `${typeDocumentLabel} - Prêt à télécharger`

      } catch (err) {
        console.error('❌ Erreur:', err)
        wordViewerLoading.style.display = "none"

        const errorHTML = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
            <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
            <style>
              * { font-family: 'Roboto', sans-serif; }
              body {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                margin: 0;
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
              }
              .container {
                background: white;
                border-radius: 16px;
                padding: 48px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
              }
              .icon {
                font-size: 80px;
                color: #dc2626;
                margin-bottom: 24px;
              }
              h1 {
                color: #1C1B1F;
                font-size: 28px;
                margin-bottom: 16px;
              }
              p {
                color: #49454F;
                font-size: 16px;
                line-height: 1.6;
              }
              .error-details {
                background: #FEE;
                border-left: 4px solid #dc2626;
                padding: 16px;
                margin-top: 24px;
                text-align: left;
                border-radius: 8px;
                font-family: monospace;
                font-size: 14px;
                color: #dc2626;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <span class="material-icons icon">error</span>
              <h1>Erreur de génération</h1>
              <p>Une erreur s'est produite lors de la génération du document Word.</p>
              <div class="error-details">${err.message}</div>
            </div>
          </body>
          </html>
        `

        wordViewerFrame.srcdoc = errorHTML
        wordViewerFrame.style.display = "block"
        document.getElementById("wordViewerSubtitle").textContent = "Erreur de génération"
      }
    }

    // Fermer le modal Word
    closeWordViewer.addEventListener("click", () => {
      wordViewerModal.classList.add("hidden")
      if (currentWordUrl) {
        URL.revokeObjectURL(currentWordUrl)
        currentWordUrl = null
      }
    })

    closeWordViewerBtn.addEventListener("click", () => {
      wordViewerModal.classList.add("hidden")
      if (currentWordUrl) {
        URL.revokeObjectURL(currentWordUrl)
        currentWordUrl = null
      }
    })
  </script>

</body>
</html>
