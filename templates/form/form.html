<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G√©n√©ration de document</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-start min-h-screen py-10">

  <form id="docForm" class="bg-white p-6 rounded-2xl shadow-md w-full max-w-md space-y-4">
    <h2 class="text-2xl font-bold text-center">G√©n√©ration de document</h2>
    
    <button type="button" id="fillTestData" class="w-full py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
      üé≤ Remplir avec donn√©es de test
    </button>

    <select id="civilite" class="w-full p-2 border rounded-lg" required>
      <option value="">Civilit√©</option>
      <option value="Monsieur">Monsieur</option>
      <option value="Madame">Madame</option>
    </select>

    <input id="statut" type="text" placeholder="Statut (ex: Pr√©sident, Directeur...)" class="w-full p-2 border rounded-lg">

    <input id="nom" type="text" placeholder="Nom" class="w-full p-2 border rounded-lg" required>

    <input id="batiment" type="text" placeholder="B√¢timent" class="w-full p-2 border rounded-lg">

    <input id="adresse" type="text" placeholder="Adresse" class="w-full p-2 border rounded-lg" required>

    <input id="cp" type="text" placeholder="Code postal + Ville (ex: 75001 Paris)" class="w-full p-2 border rounded-lg" required>

    <input id="objet" type="text" placeholder="Objet du document" class="w-full p-2 border rounded-lg">

    <input id="number" type="text" placeholder="Num√©ro (ex: 2025-001)" class="w-full p-2 border rounded-lg" required>

    <input id="nom_destinataire" type="text" placeholder="Nom du destinataire" class="w-full p-2 border rounded-lg">

    <select id="template" class="w-full p-2 border rounded-lg" required>
      <option value="">Choisir un type de documents</option>
      <option value="securite">S√©curit√© et D√©signation</option>
      <option value="designation">Mandat N√©gociation</option>
      <option value="autre">Autre</option>
    </select>

    <textarea id="texte_ai" placeholder="Texte IA (optionnel)" rows="3" class="w-full p-2 border rounded-lg"></textarea>

    <input id="civilite_replace" type="text" placeholder="Civilit√© rempla√ßant" class="w-full p-2 border rounded-lg">

    <input id="nom_replace" type="text" placeholder="Nom rempla√ßant" class="w-full p-2 border rounded-lg" required>
    
    <input id="nom_exp" type="text" placeholder="Nom exp√©diteur (ex: FO METAUX)" class="w-full p-2 border rounded-lg">

    <div class="w-full">
      <label class="block text-sm font-medium text-gray-700 mb-1">Destinataires</label>
      <div id="emailContainer" class="w-full p-2 border rounded-lg bg-white flex flex-wrap gap-2 items-center min-h-[42px] cursor-text">
        <input id="emailInput" type="text" placeholder="Tapez une adresse email et appuyez sur virgule ou espace..." class="flex-1 outline-none min-w-[200px]">
      </div>
      <input id="destinataires" type="hidden" required>
    </div>

    <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
      G√©n√©rer le document
    </button>

    <p id="message" class="text-center text-gray-700"></p>
  </form>

  <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-auto p-6 relative">
      <button id="closeModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      <div id="previewContent"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById("docForm")
    const msg = document.getElementById("message")
    const previewModal = document.getElementById("previewModal")
    const previewContent = document.getElementById("previewContent")
    const closeModal = document.getElementById("closeModal")
    
    // Gestion des chips d'emails inline
    const emailInput = document.getElementById("emailInput")
    const emailContainer = document.getElementById("emailContainer")
    const destinatairesHidden = document.getElementById("destinataires")
    let emails = []
    
    function createChip(email) {
      const chip = document.createElement('div')
      chip.className = 'flex items-center gap-1 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm'
      chip.innerHTML = `
        <span>${email}</span>
        <button type="button" class="ml-1 text-blue-600 hover:text-blue-900 font-bold text-lg leading-none">&times;</button>
      `
      chip.querySelector('button').addEventListener('click', () => {
        const index = emails.indexOf(email)
        if (index > -1) {
          emails.splice(index, 1)
          chip.remove()
          updateHiddenField()
        }
      })
      return chip
    }
    
    function updateHiddenField() {
      destinatairesHidden.value = emails.join(', ')
    }
    
    function addEmail(email) {
      email = email.trim()
      if (email && email.includes('@') && !emails.includes(email)) {
        emails.push(email)
        const chip = createChip(email)
        emailContainer.insertBefore(chip, emailInput)
        updateHiddenField()
        return true
      }
      return false
    }
    
    emailInput.addEventListener('input', (e) => {
      const value = e.target.value
      if (value.includes(',') || value.includes(';') || value.includes(' ')) {
        const parts = value.split(/[,;\s]+/)
        parts.forEach(part => {
          if (part.trim()) {
            addEmail(part)
          }
        })
        emailInput.value = ''
      }
    })
    
    emailInput.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && emailInput.value === '' && emails.length > 0) {
        emails.pop()
        const chips = emailContainer.querySelectorAll('div')
        if (chips.length > 0) {
          chips[chips.length - 1].remove()
        }
        updateHiddenField()
      }
      if (e.key === 'Enter') {
        e.preventDefault()
        if (emailInput.value.trim()) {
          addEmail(emailInput.value)
          emailInput.value = ''
        }
      }
    })
    
    emailContainer.addEventListener('click', () => {
      emailInput.focus()
    })
    
    // Bouton pour remplir avec des donn√©es de test
    document.getElementById('fillTestData').addEventListener('click', () => {
      const testData = {
        civilite: ['Monsieur', 'Madame'][Math.floor(Math.random() * 2)],
        statut: ['Pr√©sident', 'Directeur', 'Responsable RH', 'Chef de service'][Math.floor(Math.random() * 4)],
        nom: ['Dupont', 'Martin', 'Bernard', 'Dubois', 'Laurent'][Math.floor(Math.random() * 5)],
        batiment: ['B√¢timent A', 'B√¢timent B', 'Tour Nord', 'Annexe'][Math.floor(Math.random() * 4)],
        adresse: ['123 Rue de la Paix', '45 Avenue des Champs', '78 Boulevard Saint-Michel', '12 Place de la R√©publique'][Math.floor(Math.random() * 4)],
        cp: ['75001 Paris', '69002 Lyon', '13001 Marseille', '44000 Nantes'][Math.floor(Math.random() * 4)],
        objet: ['S√©curit√© au travail', 'D√©signation repr√©sentant', 'N√©gociation collective', 'R√©union CSE'][Math.floor(Math.random() * 4)],
        number: ['2025-' + String(Math.floor(Math.random() * 100) + 1).padStart(3, '0')],
        nom_destinataire: ['Jean Dupont', 'Marie Martin', 'Pierre Bernard', 'Sophie Dubois'][Math.floor(Math.random() * 4)],
        civilite_replace: ['Monsieur', 'Madame'][Math.floor(Math.random() * 2)],
        nom_replace: ['Durand', 'Petit', 'Robert', 'Moreau'][Math.floor(Math.random() * 4)],
        nom_exp: ['FO METAUX', 'Force Ouvri√®re', 'Syndicat FO'][Math.floor(Math.random() * 3)],
        template: ['securite', 'designation'][Math.floor(Math.random() * 2)],
        texte_ai: 'Ceci est un texte de test g√©n√©r√© automatiquement pour la d√©monstration.',
        emails: ['epheandrill@gmail.com', 'bouvier.jul@gmail.com']
      }
      
      document.getElementById('civilite').value = testData.civilite
      document.getElementById('statut').value = testData.statut
      document.getElementById('nom').value = testData.nom
      document.getElementById('batiment').value = testData.batiment
      document.getElementById('adresse').value = testData.adresse
      document.getElementById('cp').value = testData.cp
      document.getElementById('objet').value = testData.objet
      document.getElementById('number').value = testData.number
      document.getElementById('nom_destinataire').value = testData.nom_destinataire
      document.getElementById('civilite_replace').value = testData.civilite_replace
      document.getElementById('nom_replace').value = testData.nom_replace
      document.getElementById('nom_exp').value = testData.nom_exp
      document.getElementById('template').value = testData.template
      document.getElementById('texte_ai').value = testData.texte_ai
      
      // Remplir les emails avec chips
      emails = []
      emailContainer.querySelectorAll('div').forEach(chip => chip.remove())
      testData.emails.forEach(email => addEmail(email))
    })

    form.addEventListener("submit", async (e) => {
      e.preventDefault()
      msg.textContent = "Envoi en cours..."

      const data = {
        civilite: document.getElementById("civilite").value,
        statut: document.getElementById("statut").value,
        nom: document.getElementById("nom").value,
        batiment: document.getElementById("batiment").value,
        adresse: document.getElementById("adresse").value,
        cp: document.getElementById("cp").value,
        objet: document.getElementById("objet").value,
        number: document.getElementById("number").value,
        nom_destinataire: document.getElementById("nom_destinataire").value,
        template: document.getElementById("template").value,
        texte_ai: document.getElementById("texte_ai").value,
        civilite_replace: document.getElementById("civilite_replace").value,
        nom_replace: document.getElementById("nom_replace").value,
        destinataires: document.getElementById("destinataires").value,
        nom_exp: document.getElementById("nom_exp").value
      }

      try {
        const res = await fetch("http://localhost:3000/webhook/formulaire-doc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })

        if (!res.ok) {
          const errorText = await res.text()
          console.error(`Erreur ${res.status}:`, errorText)
          
          let errorMessage = `Erreur ${res.status}: `
          if (res.status === 404) {
            errorMessage += "Le webhook n'existe pas dans n8n.\n\n"
            errorMessage += "V√©rifiez dans n8n (http://localhost:5678):\n"
            errorMessage += "1. Que le workflow est import√©\n"
            errorMessage += "2. Que le workflow est ACTIV√â (toggle vert)\n"
            errorMessage += "3. Que le webhook a le path 'formulaire-doc'\n"
            errorMessage += "4. Ouvrez n8n ‚Üí Workflows ‚Üí Activez le workflow 'gpt_generator'"
          } else {
            errorMessage += errorText || "Erreur inconnue"
          }
          
          msg.textContent = errorMessage
          msg.style.whiteSpace = "pre-line"
          msg.style.color = "#dc2626"
          return
        }

        const result = await res.json()
        const previewWindow = window.open('', '_blank', 'width=900,height=700')
        previewWindow.document.write(result.html)
        previewWindow.document.close()
        msg.textContent = "Pr√©visualisation ouverte. Cliquez sur 'Valider et envoyer' dans la nouvelle fen√™tre."
      } catch (err) {
        console.error(err)
        msg.textContent = `Erreur: ${err.message}. V√©rifiez que le serveur de formulaire est d√©marr√© et que n8n fonctionne.`
      }
    })

    closeModal.addEventListener("click", () => {
      previewModal.classList.add("hidden")
    })
  </script>

</body>
</html>
