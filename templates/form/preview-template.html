<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <script src='https://cdn.tailwindcss.com'></script>
</head>
<body class='p-6 bg-gray-50'>
  <h2 class='text-xl font-semibold mb-4'>üìÑ Pr√©visualisation du document Word</h2>
  <div class='bg-white p-6 rounded shadow mb-4 border-2 border-gray-200' style='font-family: Calibri, Arial, sans-serif; line-height: 1.8; white-space: pre-wrap;'>
    <div class='text-sm text-gray-500 mb-4'>OBJET: <strong class='text-blue-700'>{{objet}}</strong></div>
    <div class='mb-4'>Paris, le <strong class='text-blue-700'>{{date}}</strong></div>
    {{#if statut}}<div class='mb-4'>{{statut}}</div>{{/if}}
    {{#if batiment}}<div class='mb-4'>{{batiment}}</div>{{/if}}
    {{#if adresse}}<div class='mb-4'>{{adresse}}</div>{{/if}}
    {{#if cp}}<div class='mb-4'>{{cp}}</div>{{/if}}
    <div class='mb-4' style='text-align: justify;'>{{texte_ia}}</div>
    {{#if number}}<div class='mb-4'>Num√©ro: <strong class='text-blue-700'>{{number}}</strong></div>{{/if}}
    {{#if civilite_nomme}}<div class='mb-4'>Nomm√©: <strong class='text-blue-700'>{{civilite_nomme}} {{nom_nomme}}</strong>{{#if email_nomme}} - {{email_nomme}}{{/if}}</div>{{/if}}
    {{#if civilite_replace}}<div class='mb-4'>Rempla√ßant: <strong class='text-blue-700'>{{civilite_replace}} {{nom_replace}}</strong></div>{{/if}}
    {{#if entreprise}}<div class='mb-4'>Entreprise: <strong class='text-blue-700'>{{entreprise}}</strong></div>{{/if}}
    <div class='mb-4'>Je reste √† votre disposition pour toute information compl√©mentaire.</div>
    <div class='mb-4'>Cordialement,</div>
    {{#if nom_exp}}<div class='mb-4'><strong class='text-blue-700'>{{nom_exp}}</strong></div>{{/if}}
    <hr class='my-4'>
    <div class='text-xs text-gray-400'>Email destinataire : <strong class='text-blue-700'>{{email_destinataire}}</strong></div>
  </div>
  <div class='bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4'>
    <p class='text-sm'><strong>‚ÑπÔ∏è Les parties en <span class='text-blue-700 font-bold'>bleu gras</span> sont les donn√©es ins√©r√©es dans le template Word</strong></p>
  </div>
  <form id='form' class='flex flex-col gap-4'>
    <input type='hidden' name='civilite' value='{{civilite}}'>
    <input type='hidden' name='statut' value='{{statut}}'>
    <input type='hidden' name='batiment' value='{{batiment}}'>
    <input type='hidden' name='adresse' value='{{adresse}}'>
    <input type='hidden' name='cp' value='{{cp}}'>
    <input type='hidden' name='objet' value='{{objet}}'>
    <input type='hidden' name='texte_ia' value='{{texte_ia}}'>
    <input type='hidden' name='number' value='{{number}}'>
    <input type='hidden' name='civilite_nomme' value='{{civilite_nomme}}'>
    <input type='hidden' name='nom_nomme' value='{{nom_nomme}}'>
    <input type='hidden' name='email_nomme' value='{{email_nomme}}'>
    <input type='hidden' name='civilite_replace' value='{{civilite_replace}}'>
    <input type='hidden' name='nom_replace' value='{{nom_replace}}'>
    <input type='hidden' name='entreprise' value='{{entreprise}}'>
    <input type='hidden' name='email_destinataire' value='{{email_destinataire}}'>
    <input type='hidden' name='nom_exp' value='{{nom_exp}}'>
    <input type='hidden' name='wordfile' value='{{wordBase64}}'>
    <div class='flex gap-2'>
      <button type='submit' class='bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700'>
        ‚úÖ Valider et envoyer par email
      </button>
      <button type='button' onclick='window.close()' class='bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600'>
        ‚ùå Annuler
      </button>
    </div>
  </form>
  <script>
    document.querySelector('#form').onsubmit = async e => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type=submit]');
      btn.disabled = true;
      btn.textContent = '‚è≥ Envoi en cours...';
      try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        console.log('Envoi donn√©es:', { objet: data.objet, destinataires: data.email_destinataire, wordfileLength: data.wordfile?.length });
        await fetch('http://localhost:5678/webhook/validate-doc', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        alert('‚úÖ Document envoy√© avec succ√®s!');
        window.close();
      } catch(err) {
        alert('‚ùå Erreur: ' + err.message);
        btn.disabled = false;
        btn.textContent = '‚úÖ Valider et envoyer par email';
      }
    };
  </script>
</body>
</html>
